<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">finance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.group78.financetracker.service</a> &gt; <span class="el_source">ReportGenerator.java</span></div><h1>ReportGenerator.java</h1><pre class="source lang-java linenums">package com.group78.financetracker.service;

import com.group78.financetracker.model.Transaction;
import com.group78.financetracker.model.TransactionType;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.YearMonth;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.stream.Collectors;

/**
 * Generates various reports based on transaction data
 */
public class ReportGenerator {
<span class="fc" id="L24">    private static final Logger logger = LoggerFactory.getLogger(ReportGenerator.class);</span>
    private final AIService aiService;
    
<span class="fc" id="L27">    public ReportGenerator(AIService aiService) {</span>
<span class="fc" id="L28">        this.aiService = aiService;</span>
<span class="fc" id="L29">    }</span>
    
    /**
     * Test for exception handling during report generation
     * 
     * @param type Report type (income-expense, cash-flow, savings)
     * @param transactions List of transactions to analyze
     * @return HTML formatted report
     */
    public String generateReport(String type, List&lt;Transaction&gt; transactions) {
        try {
            // Create output directory if it doesn't exist
<span class="fc" id="L41">            createOutputDirectory();</span>
            
            // Basic financial calculations
<span class="fc" id="L44">            FinancialMetrics metrics = calculateFinancialMetrics(transactions);</span>
            
            // Generate appropriate report based on type
<span class="fc" id="L47">            String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyyMMdd_HHmmss&quot;));</span>
            String reportContent;
            
<span class="fc bfc" id="L50" title="All 4 branches covered.">            switch (type) {</span>
                case &quot;income-expense&quot;:
<span class="fc" id="L52">                    reportContent = generateIncomeExpenseReport(metrics, timestamp);</span>
<span class="fc" id="L53">                    break;</span>
                case &quot;cash-flow&quot;:
<span class="fc" id="L55">                    reportContent = generateCashFlowReport(metrics, timestamp);</span>
<span class="fc" id="L56">                    break;</span>
                case &quot;savings&quot;:
<span class="fc" id="L58">                    reportContent = generateSavingsReport(metrics, timestamp);</span>
<span class="fc" id="L59">                    break;</span>
                default:
<span class="fc" id="L61">                    return &quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;Invalid report type: '&quot; + type + &quot;'. Please select a valid report type.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
            }
            
<span class="fc" id="L64">            return reportContent;</span>
<span class="nc" id="L65">        } catch (Exception e) {</span>
<span class="nc" id="L66">            logger.error(&quot;Error generating report: {}&quot;, e.getMessage(), e);</span>
<span class="nc" id="L67">            return &quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;Failed to generate report: &quot; </span>
<span class="nc" id="L68">                + e.getMessage() + &quot;&lt;/p&gt;&lt;p&gt;Please try again or contact support if the issue persists.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;;</span>
        }
    }
    
    /**
     * Helper class to store financial metrics
     */
    private static class FinancialMetrics {
        public final BigDecimal totalIncome;
        public final BigDecimal totalExpenses;
        public final BigDecimal netSavings;
        public final BigDecimal savingsRate;
        public final Map&lt;String, BigDecimal&gt; categoryTotals;
        public final Map&lt;YearMonth, Map&lt;TransactionType, BigDecimal&gt;&gt; monthlyTotals;
        public final List&lt;YearMonth&gt; sortedMonths;
        
        public FinancialMetrics(
                BigDecimal totalIncome, 
                BigDecimal totalExpenses,
                BigDecimal netSavings,
                BigDecimal savingsRate,
                Map&lt;String, BigDecimal&gt; categoryTotals,
                Map&lt;YearMonth, Map&lt;TransactionType, BigDecimal&gt;&gt; monthlyTotals,
<span class="fc" id="L91">                List&lt;YearMonth&gt; sortedMonths) {</span>
<span class="fc" id="L92">            this.totalIncome = totalIncome;</span>
<span class="fc" id="L93">            this.totalExpenses = totalExpenses;</span>
<span class="fc" id="L94">            this.netSavings = netSavings;</span>
<span class="fc" id="L95">            this.savingsRate = savingsRate;</span>
<span class="fc" id="L96">            this.categoryTotals = categoryTotals;</span>
<span class="fc" id="L97">            this.monthlyTotals = monthlyTotals;</span>
<span class="fc" id="L98">            this.sortedMonths = sortedMonths;</span>
<span class="fc" id="L99">        }</span>
    }
    
    /**
     * Calculate financial metrics from transaction data
     */
    private FinancialMetrics calculateFinancialMetrics(List&lt;Transaction&gt; transactions) {
        // Calculate total income and expenses
<span class="fc" id="L107">        BigDecimal totalIncome = transactions.stream()</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.INCOME)</span>
<span class="fc" id="L109">            .map(Transaction::getAmount)</span>
<span class="fc" id="L110">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L112">        BigDecimal totalExpenses = transactions.stream()</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.EXPENSE)</span>
<span class="fc" id="L114">            .map(Transaction::getAmount)</span>
<span class="fc" id="L115">            .reduce(BigDecimal.ZERO, BigDecimal::add);</span>
        
<span class="fc" id="L117">        BigDecimal netSavings = totalIncome.subtract(totalExpenses);</span>
        
        // Calculate savings rate
<span class="fc" id="L120">        BigDecimal savingsRate = BigDecimal.ZERO;</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (totalIncome.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="fc" id="L122">            savingsRate = netSavings.multiply(new BigDecimal(&quot;100&quot;))</span>
<span class="fc" id="L123">                .divide(totalIncome, 2, RoundingMode.HALF_UP);</span>
        }
        
        // Calculate expense categories
<span class="fc" id="L127">        Map&lt;String, BigDecimal&gt; categoryTotals = transactions.stream()</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">            .filter(t -&gt; t.getType() == TransactionType.EXPENSE)</span>
<span class="fc" id="L129">            .collect(Collectors.groupingBy(</span>
                Transaction::getCategory,
<span class="fc" id="L131">                Collectors.reducing(BigDecimal.ZERO, Transaction::getAmount, BigDecimal::add)</span>
            ));
        
        // Group by month and calculate monthly totals
<span class="fc" id="L135">        Map&lt;YearMonth, List&lt;Transaction&gt;&gt; transactionsByMonth = transactions.stream()</span>
<span class="fc" id="L136">            .collect(Collectors.groupingBy(t -&gt; YearMonth.from(t.getDateTime())));</span>
        
<span class="fc" id="L138">        Map&lt;YearMonth, Map&lt;TransactionType, BigDecimal&gt;&gt; monthlyTotals = new HashMap&lt;&gt;();</span>
        
<span class="fc bfc" id="L140" title="All 2 branches covered.">        for (Map.Entry&lt;YearMonth, List&lt;Transaction&gt;&gt; entry : transactionsByMonth.entrySet()) {</span>
<span class="fc" id="L141">            YearMonth month = entry.getKey();</span>
<span class="fc" id="L142">            List&lt;Transaction&gt; monthTransactions = entry.getValue();</span>
            
<span class="fc" id="L144">            Map&lt;TransactionType, BigDecimal&gt; typeTotals = monthTransactions.stream()</span>
<span class="fc" id="L145">                .collect(Collectors.groupingBy(</span>
                    Transaction::getType,
<span class="fc" id="L147">                    Collectors.reducing(BigDecimal.ZERO, Transaction::getAmount, BigDecimal::add)</span>
                ));
            
<span class="fc" id="L150">            monthlyTotals.put(month, typeTotals);</span>
<span class="fc" id="L151">        }</span>
        
        // Sort months chronologically
<span class="fc" id="L154">        List&lt;YearMonth&gt; sortedMonths = new ArrayList&lt;&gt;(monthlyTotals.keySet());</span>
<span class="fc" id="L155">        sortedMonths.sort(YearMonth::compareTo);</span>
        
<span class="fc" id="L157">        return new FinancialMetrics(</span>
            totalIncome, totalExpenses, netSavings, savingsRate, 
            categoryTotals, monthlyTotals, sortedMonths);
    }
    
    /**
     * Generate income and expense report
     */
    private String generateIncomeExpenseReport(FinancialMetrics metrics, String timestamp) throws IOException {
<span class="fc" id="L166">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L167">        sb.append(&quot;&lt;html&gt;&lt;body&gt;&quot;);</span>
<span class="fc" id="L168">        sb.append(&quot;&lt;h1&gt;Income and Expense Report&lt;/h1&gt;&quot;);</span>
        
        // Financial summary
<span class="fc" id="L171">        sb.append(&quot;&lt;div style='background-color:#e8f5e9; padding:15px; border-radius:8px; margin:15px 0;'&gt;&quot;);</span>
<span class="fc" id="L172">        sb.append(&quot;&lt;h2&gt;Financial Summary&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L173">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L174">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Total Income&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.totalIncome)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L175">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Total Expenses&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.totalExpenses)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L176">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Net Savings&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.netSavings)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L177">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Savings Rate&lt;/th&gt;&lt;td&gt;&quot;).append(formatAmount(metrics.savingsRate)).append(&quot;%&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L178">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="fc" id="L179">        sb.append(&quot;&lt;/div&gt;&quot;);</span>
        
        // Monthly breakdown
<span class="fc" id="L182">        sb.append(&quot;&lt;h2&gt;Monthly Summary&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L183">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L184">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Month&lt;/th&gt;&lt;th&gt;Income&lt;/th&gt;&lt;th&gt;Expenses&lt;/th&gt;&lt;th&gt;Net&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
        
<span class="fc bfc" id="L186" title="All 2 branches covered.">        for (YearMonth month : metrics.sortedMonths) {</span>
<span class="fc" id="L187">            BigDecimal income = metrics.monthlyTotals.get(month).getOrDefault(TransactionType.INCOME, BigDecimal.ZERO);</span>
<span class="fc" id="L188">            BigDecimal expenses = metrics.monthlyTotals.get(month).getOrDefault(TransactionType.EXPENSE, BigDecimal.ZERO);</span>
<span class="fc" id="L189">            BigDecimal net = income.subtract(expenses);</span>
            
<span class="fc" id="L191">            sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L192">            sb.append(&quot;&lt;td&gt;&quot;).append(month.format(DateTimeFormatter.ofPattern(&quot;MMMM yyyy&quot;))).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L193">            sb.append(&quot;&lt;td style='color:green;'&gt;$&quot;).append(formatAmount(income)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L194">            sb.append(&quot;&lt;td style='color:red;'&gt;$&quot;).append(formatAmount(expenses)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L195">            sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(net)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L196">            sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L197">        }</span>
        
<span class="fc" id="L199">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
        
        // Category breakdown
<span class="fc" id="L202">        sb.append(&quot;&lt;h2&gt;Expense Categories&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L203">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L204">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Amount&lt;/th&gt;&lt;th&gt;Percentage&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
        
        // Sort categories by amount
<span class="fc" id="L207">        metrics.categoryTotals.entrySet().stream()</span>
<span class="fc" id="L208">            .sorted((e1, e2) -&gt; e2.getValue().compareTo(e1.getValue()))</span>
<span class="fc" id="L209">            .forEach(entry -&gt; {</span>
<span class="fc" id="L210">                BigDecimal percentage = entry.getValue().multiply(new BigDecimal(&quot;100&quot;))</span>
<span class="fc" id="L211">                    .divide(metrics.totalExpenses, 2, RoundingMode.HALF_UP);</span>
                
<span class="fc" id="L213">                sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L214">                sb.append(&quot;&lt;td&gt;&quot;).append(entry.getKey()).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L215">                sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(entry.getValue())).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L216">                sb.append(&quot;&lt;td&gt;&quot;).append(formatAmount(percentage)).append(&quot;%&lt;/td&gt;&quot;);</span>
<span class="fc" id="L217">                sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L218">            });</span>
        
<span class="fc" id="L220">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
        
        // Export notification
<span class="fc" id="L223">        File reportFile = new File(&quot;output/income_expense_report_&quot; + timestamp + &quot;.html&quot;);</span>
<span class="fc" id="L224">        saveHtmlReport(sb.toString(), reportFile);</span>
        
<span class="fc" id="L226">        sb.append(&quot;&lt;h2&gt;Exported Report&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L227">        sb.append(&quot;&lt;p&gt;Report has been saved to: &lt;a href='&quot;).append(reportFile.toURI()).append(&quot;'&gt;&quot;)</span>
<span class="fc" id="L228">          .append(reportFile.getName()).append(&quot;&lt;/a&gt;&lt;/p&gt;&quot;);</span>
        
<span class="fc" id="L230">        sb.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L231">        return sb.toString();</span>
    }
    
    /**
     * Generate cash flow forecast report
     */
    private String generateCashFlowReport(FinancialMetrics metrics, String timestamp) throws IOException {
<span class="fc" id="L238">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L239">        sb.append(&quot;&lt;html&gt;&lt;body&gt;&quot;);</span>
<span class="fc" id="L240">        sb.append(&quot;&lt;h1&gt;Cash Flow Forecast (Next 6 Months)&lt;/h1&gt;&quot;);</span>
        
        // Check if we have enough data
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (metrics.sortedMonths.size() &lt; 3) {</span>
<span class="nc" id="L244">            sb.append(&quot;&lt;p class='highlight'&gt;At least 3 months of transaction history is needed for accurate forecasting.&lt;/p&gt;&quot;);</span>
<span class="nc" id="L245">            sb.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L246">            return sb.toString();</span>
        }
        
        // Get recent months for forecasting
<span class="fc" id="L250">        int monthsToUse = Math.min(metrics.sortedMonths.size(), 6);</span>
<span class="fc" id="L251">        List&lt;YearMonth&gt; recentMonths = metrics.sortedMonths.subList(metrics.sortedMonths.size() - monthsToUse, metrics.sortedMonths.size());</span>
        
        // Calculate trends
<span class="fc" id="L254">        BigDecimal avgMonthlyIncome = calculateAverageMonthly(recentMonths, TransactionType.INCOME, metrics.monthlyTotals);</span>
<span class="fc" id="L255">        BigDecimal avgMonthlyExpenses = calculateAverageMonthly(recentMonths, TransactionType.EXPENSE, metrics.monthlyTotals);</span>
<span class="fc" id="L256">        BigDecimal avgMonthlySavings = avgMonthlyIncome.subtract(avgMonthlyExpenses);</span>
        
        // Add Forecast Summary section
<span class="fc" id="L259">        sb.append(&quot;&lt;div style='background-color:#e3f2fd; padding:15px; border-radius:8px; margin:15px 0;'&gt;&quot;);</span>
<span class="fc" id="L260">        sb.append(&quot;&lt;h2&gt;Forecast Summary&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L261">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L262">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Average Monthly Income&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(avgMonthlyIncome)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L263">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Average Monthly Expenses&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(avgMonthlyExpenses)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L264">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Average Monthly Savings&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(avgMonthlySavings)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L265">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="fc" id="L266">        sb.append(&quot;&lt;/div&gt;&quot;);</span>
        
        // Forecast next 6 months
<span class="fc" id="L269">        YearMonth lastMonth = metrics.sortedMonths.get(metrics.sortedMonths.size() - 1);</span>
<span class="fc" id="L270">        List&lt;YearMonth&gt; forecastMonths = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">        for (int i = 1; i &lt;= 6; i++) {</span>
<span class="fc" id="L272">            forecastMonths.add(lastMonth.plusMonths(i));</span>
        }
        
        // Monthly forecast
<span class="fc" id="L276">        sb.append(&quot;&lt;h2&gt;6-Month Projection&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L277">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L278">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Month&lt;/th&gt;&lt;th&gt;Projected Income&lt;/th&gt;&lt;th&gt;Projected Expenses&lt;/th&gt;&lt;th&gt;Projected Net&lt;/th&gt;&lt;th&gt;Cumulative&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
        
<span class="fc" id="L280">        BigDecimal currentSavings = metrics.netSavings;</span>
<span class="fc" id="L281">        BigDecimal cumulativeSavings = currentSavings;</span>
        
<span class="fc bfc" id="L283" title="All 2 branches covered.">        for (YearMonth month : forecastMonths) {</span>
            // Apply simple trend calculation
<span class="fc" id="L285">            BigDecimal projectedIncome = avgMonthlyIncome;</span>
<span class="fc" id="L286">            BigDecimal projectedExpenses = avgMonthlyExpenses;</span>
<span class="fc" id="L287">            BigDecimal projectedNet = projectedIncome.subtract(projectedExpenses);</span>
<span class="fc" id="L288">            cumulativeSavings = cumulativeSavings.add(projectedNet);</span>
            
<span class="fc" id="L290">            sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L291">            sb.append(&quot;&lt;td&gt;&quot;).append(month.format(DateTimeFormatter.ofPattern(&quot;MMMM yyyy&quot;))).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L292">            sb.append(&quot;&lt;td style='color:green;'&gt;$&quot;).append(formatAmount(projectedIncome)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L293">            sb.append(&quot;&lt;td style='color:red;'&gt;$&quot;).append(formatAmount(projectedExpenses)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L294">            sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(projectedNet)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L295">            sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(cumulativeSavings)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L296">            sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L297">        }</span>
        
<span class="fc" id="L299">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
        
        // Financial Risk Assessment
<span class="fc" id="L302">        sb.append(&quot;&lt;h2&gt;Financial Risk Assessment&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L303">        sb.append(&quot;&lt;div style='padding:10px; border-radius:8px; margin:10px 0;&quot;);</span>
        
        // Determine risk level
        String riskLevel;
        String riskColor;
        String riskDescription;
        
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">        if (avgMonthlySavings.compareTo(BigDecimal.ZERO) &lt;= 0) {</span>
<span class="nc" id="L311">            riskLevel = &quot;High Risk&quot;;</span>
<span class="nc" id="L312">            riskColor = &quot;#ffebee&quot;; // Light red</span>
<span class="nc" id="L313">            riskDescription = &quot;You are spending more than your income. This is not sustainable long-term.&quot;;</span>
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        } else if (metrics.savingsRate.compareTo(new BigDecimal(&quot;10&quot;)) &lt; 0) {</span>
<span class="nc" id="L315">            riskLevel = &quot;Moderate Risk&quot;;</span>
<span class="nc" id="L316">            riskColor = &quot;#fff8e1&quot;; // Light amber</span>
<span class="nc" id="L317">            riskDescription = &quot;Your savings rate is low. Consider reducing non-essential expenses.&quot;;</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">        } else if (metrics.savingsRate.compareTo(new BigDecimal(&quot;20&quot;)) &lt; 0) {</span>
<span class="nc" id="L319">            riskLevel = &quot;Low Risk&quot;;</span>
<span class="nc" id="L320">            riskColor = &quot;#e8f5e9&quot;; // Light green</span>
<span class="nc" id="L321">            riskDescription = &quot;Your finances are in good shape, but there's room for improvement.&quot;;</span>
        } else {
<span class="fc" id="L323">            riskLevel = &quot;Excellent&quot;;</span>
<span class="fc" id="L324">            riskColor = &quot;#e8f5e9&quot;; // Light green</span>
<span class="fc" id="L325">            riskDescription = &quot;You have a healthy savings rate. Keep up the good work!&quot;;</span>
        }
        
<span class="fc" id="L328">        sb.append(&quot;background-color:&quot;).append(riskColor).append(&quot;;'&gt;&quot;);</span>
<span class="fc" id="L329">        sb.append(&quot;&lt;h3&gt;&quot;).append(riskLevel).append(&quot;&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L330">        sb.append(&quot;&lt;p&gt;&quot;).append(riskDescription).append(&quot;&lt;/p&gt;&quot;);</span>
        
        // Get AI insights
<span class="fc" id="L333">        sb.append(&quot;&lt;h3&gt;AI Insights&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L334">        String aiInsight = &quot;Based on your financial data, consider setting aside emergency funds equivalent to 3-6 months of expenses. &quot;</span>
                         + &quot;It's also prudent to plan for future large expenses and create a detailed monthly budget. &quot;
                         + &quot;If your savings rate is below 20%, consider reviewing discretionary spending.&quot;;
        
<span class="fc" id="L338">        sb.append(&quot;&lt;p&gt;&quot;).append(aiInsight).append(&quot;&lt;/p&gt;&quot;);</span>
<span class="fc" id="L339">        sb.append(&quot;&lt;/div&gt;&quot;);</span>
        
        // Export notification
<span class="fc" id="L342">        File reportFile = new File(&quot;output/cash_flow_forecast_&quot; + timestamp + &quot;.html&quot;);</span>
<span class="fc" id="L343">        saveHtmlReport(sb.toString(), reportFile);</span>
        
<span class="fc" id="L345">        sb.append(&quot;&lt;h2&gt;Exported Report&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L346">        sb.append(&quot;&lt;p&gt;Report has been saved to: &lt;a href='&quot;).append(reportFile.toURI()).append(&quot;'&gt;&quot;)</span>
<span class="fc" id="L347">          .append(reportFile.getName()).append(&quot;&lt;/a&gt;&lt;/p&gt;&quot;);</span>
        
<span class="fc" id="L349">        sb.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L350">        return sb.toString();</span>
    }
    
    /**
     * Helper method to calculate average monthly amounts
     */
    private BigDecimal calculateAverageMonthly(List&lt;YearMonth&gt; months, TransactionType type, 
            Map&lt;YearMonth, Map&lt;TransactionType, BigDecimal&gt;&gt; monthlyTotals) {
<span class="fc" id="L358">        BigDecimal sum = BigDecimal.ZERO;</span>
<span class="fc" id="L359">        int count = 0;</span>
        
<span class="fc bfc" id="L361" title="All 2 branches covered.">        for (YearMonth month : months) {</span>
<span class="fc" id="L362">            Map&lt;TransactionType, BigDecimal&gt; typeTotals = monthlyTotals.get(month);</span>
<span class="pc bpc" id="L363" title="1 of 4 branches missed.">            if (typeTotals != null &amp;&amp; typeTotals.containsKey(type)) {</span>
<span class="fc" id="L364">                sum = sum.add(typeTotals.get(type));</span>
<span class="fc" id="L365">                count++;</span>
            }
<span class="fc" id="L367">        }</span>
        
<span class="pc bpc" id="L369" title="1 of 2 branches missed.">        if (count == 0) {</span>
<span class="nc" id="L370">            return BigDecimal.ZERO;</span>
        }
        
<span class="fc" id="L373">        return sum.divide(new BigDecimal(count), 2, RoundingMode.HALF_UP);</span>
    }
    
    /**
     * Generate savings recommendations report
     */
    private String generateSavingsReport(FinancialMetrics metrics, String timestamp) throws IOException {
<span class="fc" id="L380">        StringBuilder sb = new StringBuilder();</span>
<span class="fc" id="L381">        sb.append(&quot;&lt;html&gt;&lt;body&gt;&quot;);</span>
<span class="fc" id="L382">        sb.append(&quot;&lt;h1&gt;Smart Savings Recommendations&lt;/h1&gt;&quot;);</span>
        
        // Financial overview
<span class="fc" id="L385">        sb.append(&quot;&lt;div style='background-color:#e8f5e9; padding:15px; border-radius:8px; margin:15px 0;'&gt;&quot;);</span>
<span class="fc" id="L386">        sb.append(&quot;&lt;h2&gt;Financial Overview&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L387">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L388">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Total Income&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.totalIncome)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L389">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Total Expenses&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.totalExpenses)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L390">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Net Savings&lt;/th&gt;&lt;td&gt;$&quot;).append(formatAmount(metrics.netSavings)).append(&quot;&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L391">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Savings Rate&lt;/th&gt;&lt;td&gt;&quot;).append(formatAmount(metrics.savingsRate)).append(&quot;%&lt;/td&gt;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L392">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
<span class="fc" id="L393">        sb.append(&quot;&lt;/div&gt;&quot;);</span>
        
        // Savings rate assessment
<span class="fc" id="L396">        sb.append(&quot;&lt;h2&gt;Savings Rate Assessment&lt;/h2&gt;&quot;);</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">        if (metrics.savingsRate.compareTo(new BigDecimal(&quot;20&quot;)) &gt;= 0) {</span>
<span class="fc" id="L398">            sb.append(&quot;&lt;div style='background-color:#e8f5e9; padding:15px; border-left:4px solid #4caf50; margin:15px 0;'&gt;&quot;);</span>
<span class="fc" id="L399">            sb.append(&quot;&lt;h3 style='color:#2e7d32; margin-top:0;'&gt;Excellent Savings Rate&lt;/h3&gt;&quot;);</span>
<span class="fc" id="L400">            sb.append(&quot;&lt;p&gt;Your savings rate of &quot;).append(formatAmount(metrics.savingsRate)).append(&quot;% is excellent! &quot;);</span>
<span class="fc" id="L401">            sb.append(&quot;This puts you in a strong position for future financial goals.&lt;/p&gt;&quot;);</span>
<span class="fc" id="L402">            sb.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        } else if (metrics.savingsRate.compareTo(new BigDecimal(&quot;10&quot;)) &gt;= 0) {</span>
<span class="nc" id="L404">            sb.append(&quot;&lt;div style='background-color:#fff8e1; padding:15px; border-left:4px solid #ffc107; margin:15px 0;'&gt;&quot;);</span>
<span class="nc" id="L405">            sb.append(&quot;&lt;h3 style='color:#ff8f00; margin-top:0;'&gt;Good Savings Rate&lt;/h3&gt;&quot;);</span>
<span class="nc" id="L406">            sb.append(&quot;&lt;p&gt;Your savings rate of &quot;).append(formatAmount(metrics.savingsRate)).append(&quot;% is good, &quot;);</span>
<span class="nc" id="L407">            sb.append(&quot;but there's room for improvement. Aim for 20% for optimal financial health.&lt;/p&gt;&quot;);</span>
<span class="nc" id="L408">            sb.append(&quot;&lt;/div&gt;&quot;);</span>
        } else {
<span class="nc" id="L410">            sb.append(&quot;&lt;div style='background-color:#ffebee; padding:15px; border-left:4px solid #f44336; margin:15px 0;'&gt;&quot;);</span>
<span class="nc" id="L411">            sb.append(&quot;&lt;h3 style='color:#c62828; margin-top:0;'&gt;Low Savings Rate&lt;/h3&gt;&quot;);</span>
<span class="nc" id="L412">            sb.append(&quot;&lt;p&gt;Your savings rate of &quot;).append(formatAmount(metrics.savingsRate)).append(&quot;% is below &quot;);</span>
<span class="nc" id="L413">            sb.append(&quot;the recommended minimum of 10%. This limits your financial security and future options.&lt;/p&gt;&quot;);</span>
<span class="nc" id="L414">            sb.append(&quot;&lt;/div&gt;&quot;);</span>
        }
        
        // Top expense categories
<span class="fc" id="L418">        sb.append(&quot;&lt;h2&gt;Top Expense Categories&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L419">        sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L420">        sb.append(&quot;&lt;tr&gt;&lt;th&gt;Category&lt;/th&gt;&lt;th&gt;Amount&lt;/th&gt;&lt;th&gt;Percentage&lt;/th&gt;&lt;th&gt;Potential Savings&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
        
        // Define category thresholds
<span class="fc" id="L423">        Map&lt;String, BigDecimal&gt; categoryThresholds = new HashMap&lt;&gt;();</span>
<span class="fc" id="L424">        categoryThresholds.put(&quot;Housing&quot;, new BigDecimal(&quot;30&quot;));</span>
<span class="fc" id="L425">        categoryThresholds.put(&quot;Food&quot;, new BigDecimal(&quot;15&quot;));</span>
<span class="fc" id="L426">        categoryThresholds.put(&quot;Transportation&quot;, new BigDecimal(&quot;15&quot;));</span>
<span class="fc" id="L427">        categoryThresholds.put(&quot;Entertainment&quot;, new BigDecimal(&quot;10&quot;));</span>
<span class="fc" id="L428">        categoryThresholds.put(&quot;Shopping&quot;, new BigDecimal(&quot;10&quot;));</span>
<span class="fc" id="L429">        categoryThresholds.put(&quot;Utilities&quot;, new BigDecimal(&quot;10&quot;));</span>
        
<span class="fc" id="L431">        BigDecimal totalPotentialSavings = BigDecimal.ZERO;</span>
        
<span class="fc" id="L433">        for (Map.Entry&lt;String, BigDecimal&gt; entry : metrics.categoryTotals.entrySet().stream()</span>
<span class="fc" id="L434">                .sorted((e1, e2) -&gt; e2.getValue().compareTo(e1.getValue()))</span>
<span class="fc" id="L435">                .limit(6)</span>
<span class="fc bfc" id="L436" title="All 2 branches covered.">                .collect(Collectors.toList())) {</span>
            
<span class="fc" id="L438">            String category = entry.getKey();</span>
<span class="fc" id="L439">            BigDecimal amount = entry.getValue();</span>
<span class="fc" id="L440">            BigDecimal percentage = amount.multiply(new BigDecimal(&quot;100&quot;))</span>
<span class="fc" id="L441">                .divide(metrics.totalExpenses, 2, RoundingMode.HALF_UP);</span>
            
<span class="fc" id="L443">            BigDecimal threshold = categoryThresholds.getOrDefault(category, new BigDecimal(&quot;10&quot;));</span>
<span class="fc" id="L444">            BigDecimal potentialSavings = BigDecimal.ZERO;</span>
            
            // If over threshold, calculate potential savings
<span class="fc bfc" id="L447" title="All 2 branches covered.">            if (percentage.compareTo(threshold) &gt; 0) {</span>
<span class="fc" id="L448">                BigDecimal overagePercentage = percentage.subtract(threshold);</span>
<span class="fc" id="L449">                potentialSavings = metrics.totalExpenses.multiply(overagePercentage)</span>
<span class="fc" id="L450">                    .divide(new BigDecimal(&quot;100&quot;), 2, RoundingMode.HALF_UP);</span>
<span class="fc" id="L451">                totalPotentialSavings = totalPotentialSavings.add(potentialSavings);</span>
            }
            
<span class="fc" id="L454">            sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc" id="L455">            sb.append(&quot;&lt;td&gt;&quot;).append(category).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L456">            sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(amount)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L457">            sb.append(&quot;&lt;td&gt;&quot;).append(formatAmount(percentage)).append(&quot;%&lt;/td&gt;&quot;);</span>
            
<span class="fc bfc" id="L459" title="All 2 branches covered.">            if (potentialSavings.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="fc" id="L460">                sb.append(&quot;&lt;td style='color:green;'&gt;$&quot;).append(formatAmount(potentialSavings)).append(&quot;&lt;/td&gt;&quot;);</span>
            } else {
<span class="fc" id="L462">                sb.append(&quot;&lt;td&gt;$0.00&lt;/td&gt;&quot;);</span>
            }
            
<span class="fc" id="L465">            sb.append(&quot;&lt;/tr&gt;&quot;);</span>
<span class="fc" id="L466">        }</span>
        
<span class="fc" id="L468">        sb.append(&quot;&lt;/table&gt;&quot;);</span>
        
        // Savings potential
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">        if (totalPotentialSavings.compareTo(BigDecimal.ZERO) &gt; 0) {</span>
<span class="fc" id="L472">            sb.append(&quot;&lt;div style='background-color:#e8f5e9; padding:15px; border-radius:8px; margin:15px 0;'&gt;&quot;);</span>
<span class="fc" id="L473">            sb.append(&quot;&lt;h2&gt;Total Savings Potential&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L474">            sb.append(&quot;&lt;p&gt;By optimizing your spending in the categories above, you could potentially save up to &quot;);</span>
<span class="fc" id="L475">            sb.append(&quot;&lt;strong style='color:green;'&gt;$&quot;).append(formatAmount(totalPotentialSavings)).append(&quot;&lt;/strong&gt;.&lt;/p&gt;&quot;);</span>
            
            // Calculate improved savings rate
<span class="fc" id="L478">            BigDecimal improvedSavings = metrics.netSavings.add(totalPotentialSavings);</span>
<span class="fc" id="L479">            BigDecimal improvedRate = improvedSavings.multiply(new BigDecimal(&quot;100&quot;))</span>
<span class="fc" id="L480">                .divide(metrics.totalIncome, 2, RoundingMode.HALF_UP);</span>
            
<span class="fc" id="L482">            sb.append(&quot;&lt;p&gt;This would increase your savings rate from &quot;)</span>
<span class="fc" id="L483">              .append(formatAmount(metrics.savingsRate)).append(&quot;% to &quot;)</span>
<span class="fc" id="L484">              .append(formatAmount(improvedRate)).append(&quot;%.&lt;/p&gt;&quot;);</span>
<span class="fc" id="L485">            sb.append(&quot;&lt;/div&gt;&quot;);</span>
            
            // Long-term impact
<span class="fc" id="L488">            sb.append(&quot;&lt;h2&gt;Long-Term Impact of Improved Savings&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L489">            sb.append(&quot;&lt;table&gt;&quot;);</span>
<span class="fc" id="L490">            sb.append(&quot;&lt;tr&gt;&lt;th&gt;Time Period&lt;/th&gt;&lt;th&gt;Current Path&lt;/th&gt;&lt;th&gt;With Improvements&lt;/th&gt;&lt;th&gt;Difference&lt;/th&gt;&lt;/tr&gt;&quot;);</span>
            
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">            BigDecimal monthlySavings = metrics.netSavings.compareTo(BigDecimal.ZERO) &gt; 0 </span>
<span class="pc" id="L493">                ? metrics.netSavings : BigDecimal.ZERO;</span>
<span class="fc" id="L494">            BigDecimal monthlyImproved = monthlySavings.add(totalPotentialSavings);</span>
            
<span class="fc bfc" id="L496" title="All 2 branches covered.">            for (int years : new int[] {1, 3, 5, 10}) {</span>
<span class="fc" id="L497">                BigDecimal currentTotal = monthlySavings.multiply(BigDecimal.valueOf(12 * years));</span>
<span class="fc" id="L498">                BigDecimal improvedTotal = monthlyImproved.multiply(BigDecimal.valueOf(12 * years));</span>
<span class="fc" id="L499">                BigDecimal difference = improvedTotal.subtract(currentTotal);</span>
                
<span class="fc" id="L501">                sb.append(&quot;&lt;tr&gt;&quot;);</span>
<span class="fc bfc" id="L502" title="All 2 branches covered.">                sb.append(&quot;&lt;td&gt;&quot;).append(years).append(&quot; Year&quot;).append(years &gt; 1 ? &quot;s&quot; : &quot;&quot;).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L503">                sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(currentTotal)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L504">                sb.append(&quot;&lt;td&gt;$&quot;).append(formatAmount(improvedTotal)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L505">                sb.append(&quot;&lt;td style='color:green;'&gt;$&quot;).append(formatAmount(difference)).append(&quot;&lt;/td&gt;&quot;);</span>
<span class="fc" id="L506">                sb.append(&quot;&lt;/tr&gt;&quot;);</span>
            }
            
<span class="fc" id="L509">            sb.append(&quot;&lt;/table&gt;&quot;);</span>
        }
        
        // Savings tips
<span class="fc" id="L513">        sb.append(&quot;&lt;h2&gt;General Savings Tips&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L514">        sb.append(&quot;&lt;ul&gt;&quot;);</span>
<span class="fc" id="L515">        sb.append(&quot;&lt;li&gt;&lt;strong&gt;50/30/20 Rule:&lt;/strong&gt; Aim to spend 50% of income on needs, 30% on wants, and save 20%.&lt;/li&gt;&quot;);</span>
<span class="fc" id="L516">        sb.append(&quot;&lt;li&gt;&lt;strong&gt;Emergency Fund:&lt;/strong&gt; Build an emergency fund covering 3-6 months of expenses.&lt;/li&gt;&quot;);</span>
<span class="fc" id="L517">        sb.append(&quot;&lt;li&gt;&lt;strong&gt;Automate Savings:&lt;/strong&gt; Set up automatic transfers to savings accounts on payday.&lt;/li&gt;&quot;);</span>
<span class="fc" id="L518">        sb.append(&quot;&lt;li&gt;&lt;strong&gt;Review Subscriptions:&lt;/strong&gt; Regularly audit and cancel unused subscriptions.&lt;/li&gt;&quot;);</span>
<span class="fc" id="L519">        sb.append(&quot;&lt;li&gt;&lt;strong&gt;Meal Planning:&lt;/strong&gt; Plan meals ahead to reduce food waste and dining out expenses.&lt;/li&gt;&quot;);</span>
<span class="fc" id="L520">        sb.append(&quot;&lt;/ul&gt;&quot;);</span>
        
        // Export notification
<span class="fc" id="L523">        File reportFile = new File(&quot;output/savings_recommendations_&quot; + timestamp + &quot;.html&quot;);</span>
<span class="fc" id="L524">        saveHtmlReport(sb.toString(), reportFile);</span>
        
<span class="fc" id="L526">        sb.append(&quot;&lt;h2&gt;Exported Report&lt;/h2&gt;&quot;);</span>
<span class="fc" id="L527">        sb.append(&quot;&lt;p&gt;Report has been saved to: &lt;a href='&quot;).append(reportFile.toURI()).append(&quot;'&gt;&quot;)</span>
<span class="fc" id="L528">          .append(reportFile.getName()).append(&quot;&lt;/a&gt;&lt;/p&gt;&quot;);</span>
        
<span class="fc" id="L530">        sb.append(&quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
<span class="fc" id="L531">        return sb.toString();</span>
    }
    
    /**
     * Create output directory if it doesn't exist
     */
    private void createOutputDirectory() throws IOException {
<span class="fc" id="L538">        File outputDir = new File(&quot;output&quot;);</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">        if (!outputDir.exists()) {</span>
<span class="nc" id="L540">            Files.createDirectories(Paths.get(&quot;output&quot;));</span>
        }
<span class="fc" id="L542">    }</span>
    
    /**
     * Save HTML report to file
     */
    private void saveHtmlReport(String html, File file) throws IOException {
<span class="fc" id="L548">        Files.write(file.toPath(), html.getBytes());</span>
<span class="fc" id="L549">    }</span>
    
    /**
     * Format amount for display
     */
    private String formatAmount(BigDecimal amount) {
<span class="fc" id="L555">        return amount.setScale(2, RoundingMode.HALF_UP).toString();</span>
    }
} 
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>